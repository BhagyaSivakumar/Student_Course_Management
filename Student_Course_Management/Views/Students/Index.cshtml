@model IEnumerable<Student_Course_Management.Models.Student>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    ViewData["Title"] = "Students";
}

<h2 class="mb-3">Students</h2>

<p>
    <input type="text" id="txtSearch" class="form-control mb-3" placeholder="Search by name,phone or email" /><br/>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">Create New</button>
</p>

<table class="table table-bordered table-striped" id="studentTable">
    <thead class="table-dark">
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th style="width:220px;">Actions</th>
        </tr>
    </thead>
    <tbody id="StudentsTableBody">
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.StudentId</td>
                <td>@item.StudentName</td>
                <td>@item.EmailId</td>
                <td>@item.PhoneNumber</td>
                <td>
                    <button class="btn btn-info btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#detailsModal"
                            onclick="loadDetails(@item.StudentId)">
                        Details
                    </button>

                    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal" onclick="loadEdit(@item.StudentId)">Edit</button>

                    <button class="btn btn-danger btn-sm"
                            onclick="deleteStudent(@item.StudentId)">
                        Delete
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>
<a asp-controller="Mappings" asp-action="Index" class="btn btn-primary">Go To Mapping</a>

<!-- DETAILS MODAL -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-bordered">
                    <tr>
                        <th style="width:30%">Name</th>
                        <td id="dName"></td>
                    </tr>
                    <tr>
                        <th>Email</th>
                        <td id="dEmail"></td>
                    </tr>
                    <tr>
                        <th>Phone</th>
                        <td id="dPhone"></td>
                    </tr>
                    <tr>
                        <th>Created Date</th>
                        <td id="dCreated"></td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td id="dStatus"></td>
                    </tr>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Close
                </button>
            </div>

        </div>
    </div>
</div>

<!-- create modal --!>

<div class="modal fade" id="createModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5>Add Student</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="createForm">
                    <input class="form-control mb-2" name="StudentName" placeholder="Name" required />
                    <input class="form-control mb-2" name="EmailId" placeholder="Email" required />
                    <input class="form-control mb-2" name="PhoneNumber" placeholder="Phone" required />

                    <button class="btn btn-success w-100">Save</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!--Edit Modal!-->

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5>Edit Student</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" name="StudentId" id="eId" />
                    <div class="mb-2"><label>Name</label>
                        <input type="text" class="form-control mb-2" name="StudentName" id="eName" />
                    </div>
                    <div class="mb-2">
                        <label>PhoneNumber</label>
                        <input type="text" class="form-control mb-2" name="PhoneNumber" id="ePhone" />
                    </div>
                    <div class="mb-2"><label>Email</label>
                        <input type="text" class="form-control mb-2" name="EmailId" id="eEmail" />
                    </div>
                    <button type="submit" class="btn btn-success w-100">Update</button>
                </form>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const txtSearch = document.getElementById("txtSearch");

            // Search functionality
            if(txtSearch){
                txtSearch.addEventListener("keyup", () => {
                    loadStudents(txtSearch.value); // Calls the search function
                });
            loadStudents("");
            }
            loadStudents("");

            // Create student
            const createForm = document.getElementById("createForm");
            if (createForm) {
                createForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    fetch('/Students/Create', {
                        method: 'POST',
                        body: new FormData(this)
                    })
                    .then(r => r.json())
                    .then(d => {
                        alert(d.message);
                        if (d.success) location.reload();
                    })
                    .catch(error => console.error(error));
                });
            }

            // Edit student
            const editForm = document.getElementById("editForm");
            if (editForm) {
                editForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    fetch('/Students/Edit', {
                        method: 'POST',
                        body: new FormData(this)
                    })
                    .then(r => r.json())
                    .then(d => {
                        alert(d.message);
                        if (d.success) location.reload();
                    })
                    .catch(error => console.error(error));
                });
            }
        });

        // Load student data for edit
        function loadEdit(id) {
            fetch('/Students/GetStudentForEdit?id=' + id)
                .then(r => r.json())
                .then(d => {
                    document.getElementById("eId").value = d.studentId;
                    document.getElementById("eName").value = d.studentName;
                    document.getElementById("eEmail").value = d.emailId;
                    document.getElementById("ePhone").value = d.phoneNumber;
                })
                .catch(error => console.error(error));
        }

        // Load student details
        function loadDetails(id) {
            fetch('/Students/GetDetails?id=' + id)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("dName").innerText = data.studentName;
                    document.getElementById("dEmail").innerText = data.emailId;
                    document.getElementById("dPhone").innerText = data.phoneNumber;

                    if (data.createdDate) {
                        document.getElementById("dCreated").innerText =
                            new Date(data.createdDate).toLocaleDateString();
                    } else {
                        document.getElementById("dCreated").innerText = "";
                    }

                    document.getElementById("dStatus").innerText =
                        data.isActive ? "Active" : "Inactive";
                })
                .catch(error => console.error(error));
        }

        // Delete student
        function deleteStudent(id) {
            if (!confirm("Are you sure you want to delete this student?")) return;

            fetch('/Students/Delete?id=' + id, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error(error));
        }

        // --- SEARCH FUNCTION ---
        // This is the key part to make your search work
                function loadStudents(keyword) {
            fetch('/Students/Search?keyword=' + encodeURIComponent(keyword))
                .then(r => r.json()) // ✅ JSON (correct)
                .then(data => {
                    const tbody = document.getElementById("StudentsTableBody"); // ✅ correct ID
                    tbody.innerHTML = "";

                    data.forEach(s => {
                        const tr = document.createElement("tr");

                        tr.innerHTML = `
                            <td>${s.studentId}</td>
                            <td>${s.studentName}</td>
                            <td>${s.emailId}</td>
                            <td>${s.phoneNumber}</td>
                            <td>
                                <button class="btn btn-info btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#detailsModal"
                                        onclick="loadDetails(${s.studentId})">
                                    Details
                                </button>

                                <button class="btn btn-warning btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal"
                                        onclick="loadEdit(${s.studentId})">
                                    Edit
                                </button>

                                <button class="btn btn-danger btn-sm"
                                        onclick="deleteStudent(${s.studentId})">
                                    Delete
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(error => console.error(error));
        }

    </script>
}